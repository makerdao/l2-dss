on: [push, pull_request]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Print Coverage Summary
        run: forge coverage

      - name: Download Coverage Report
        run: forge coverage --report lcov

      - name: Filter Coverage
        run: |
          sudo apt update && sudo apt install -y lcov
          lcov --remove lcov.info '/src/test/*' --output-file lcov.info

      - name: Assure Coverage
        uses: zgosalvez/github-actions-report-lcov@v1
        with:
          coverage-files: ./lcov.info
          minimum-coverage: 60
